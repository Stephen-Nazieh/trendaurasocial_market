<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Everything Go-Karts ‚Äî Home</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <!-- Load Tailwind CSS for modern styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
    
    /* Global Styles */
    .header { background-color: #1f2937; color: white; padding: 1rem 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .header .inner { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 1.5rem; }
    .header .brand h1 { font-size: 1.5rem; font-weight: 900; color: #34d399; }
    .header .nav a { margin-left: 1.5rem; color: #d1d5db; text-decoration: none; transition: color 0.2s; }
    .header .nav a:hover { color: white; }

    .hero { background-color: #34d399; color: white; padding: 4rem 0; text-align: center; }
    .hero h2 { font-size: 3rem; font-weight: 700; margin-bottom: 0.5rem; }
    .hero p { font-size: 1.25rem; margin-bottom: 1.5rem; }
    
    .container { max-width: 1200px; margin: 0 auto; padding: 2rem 1.5rem; }
    .container h2 { font-size: 2rem; font-weight: 700; color: #1f2937; margin-bottom: 1.5rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; }

    /* Search Bar Styling */
    .search-bar-hero { margin-top: 2rem; width: 100%; max-width: 600px; margin-left: auto; margin-right: auto; }
    .search-bar-hero input {
      width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    /* Product Grid and Card (Detailed, Information-Forward Style) */
    #featured-products {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 2rem;
    }

    .product-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        transition: transform 0.3s, box-shadow 0.3s;
        display: flex;
        flex-direction: column;
    }
    .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    .product-media img {
        width: 100%;
        height: 200px; /* Consistent image height */
        object-fit: cover;
        transition: opacity 0.3s;
    }
    .product-info {
        padding: 1rem;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }
    .product-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 0.25rem;
        text-decoration: none;
    }
    .product-desc {
        font-size: 0.875rem;
        color: #6b7280;
        margin-bottom: 0.75rem;
        flex-grow: 1;
        /* Using line-clamp class from Tailwind JIT */
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;  
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .price-row {
        /* This row is now split into two for clearer separation */
        display: none; /* Hide old row */
    }
    .price {
        font-size: 1.5rem;
        font-weight: 700;
        color: #34d399;
    }
    .rating {
        color: #facc15; /* Yellow for stars */
        font-size: 1rem;
    }

    /* Button Styling */
    .btn {
        display: inline-block; padding: 10px 20px; background-color: #10b981; color: white; text-decoration: none;
        border-radius: 8px; font-weight: 600; transition: background-color 0.2s, box-shadow 0.2s; box-shadow: 0 4px #059669; 
    }
    .btn:hover { background-color: #059669; box-shadow: 0 2px #047857; transform: translateY(2px); }
    .btn.small { padding: 8px 16px; }

    /* Action Buttons (Cart/Wishlist) */
    .add-to-cart-btn, .add-to-wishlist-btn {
      background-color: #f3f4f6; border: 1px solid #e5e7eb; color: #4b5563; padding: 10px; font-size: 1rem;
      cursor: pointer; border-radius: 8px; transition: background-color 0.2s, color 0.2s, border-color 0.2s;
      line-height: 1; display: flex; align-items: center; justify-content: center;
    }
    
    .add-to-cart-btn:hover { background-color: #3b82f6; color: white; border-color: #3b82f6; }
    .add-to-cart-btn.added {
      background-color: #10b981 !important; color: white !important; border-color: #10b981 !important;
      cursor: default; font-weight: 600;
    }

    .add-to-wishlist-btn:hover { background-color: #ef4444; color: white; border-color: #ef4444; }
    .add-to-wishlist-btn.wished {
      background-color: #ef4444 !important; color: white !important; border-color: #ef4444 !important;
      cursor: default;
    }
  </style>
</head>
<body>
  <header class="header" role="banner">
    <div class="inner">
      <a class="brand" href="index.html"><h1>Everything Go-Karts</h1></a>
      <nav class="nav" role="navigation" aria-label="Main">
        <a href="index.html">Home</a>
        <a href="shop.html">Shop</a>
        <a href="cart.html" class="flex items-center space-x-1">
            <span>Cart</span>
            <span id="cart-count" class="bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">0</span>
        </a>
        <a href="wishlist.html">Wishlist</a>
      </nav>
    </div>
  </header>

  <section class="hero">
    <div class="inner container">
      <div>
        <h2>Welcome to the Go-Kart Market</h2>
        <p>Premium Go-Karts and Accessories.</p>
        <div class="search-bar-hero">
          <input type="text" id="hero-search-input" placeholder="Search for products, e.g., 'tires'">
        </div>
      </div>
    </div>
  </section>

  <section class="container">
    <h2>Shop by Category</h2>
    <div id="category-buttons" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
  </section>

  <main class="container" id="main">
    <h2>Featured Products</h2>
    <div id="featured-products" class="product-grid"></div>
    <div class="mt-8 text-center">
      <a class="btn" href="shop.html?primaryCategory=all">Browse all products</a>
    </div>
  </main>

  <footer class="footer bg-gray-800 text-white mt-10 py-4">
    <div class="container text-center">&copy; <span id="year"></span> TrendAura Social</div>
  </footer>

  <script>
    // Escape HTML helper
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }
    
    // Utility function for mock rating display
    function getStarRating(rating = 5) {
        const fullStar = '‚òÖ';
        const emptyStar = '‚òÜ';
        const r = Math.round(rating); // Ensure rating is an integer
        return `<span class="rating">${fullStar.repeat(r)}${emptyStar.repeat(5 - r)}</span>`;
    }

    // Updates the cart count element in the header
    function updateCartCountDisplay() {
        const cart = getCart();
        const totalItems = cart.reduce((sum, item) => sum + (item.quantity || 1), 0);
        const cartCountElement = document.getElementById('cart-count');
        if (cartCountElement) {
            cartCountElement.textContent = totalItems;
            cartCountElement.classList.toggle('hidden', totalItems === 0);
        }
    }

    // Render products into a target container
    function renderProducts(products, targetId) {
      const container = document.getElementById(targetId);
      if (!products.length) {
        container.innerHTML = "<p class='text-center text-gray-500'>No products available.</p>";
        return;
      }

      const html = products.map(p => `
        <div class="product-card">
          <a href="product.html?slug=${encodeURIComponent(p.slug)}" class="product-media">
            <!-- Added placeholder image fallback -->
            <img src="${escapeHtml(p.images[0] || 'https://placehold.co/600x400/34d399/ffffff?text=GoCart')}" 
                 alt="${escapeHtml(p.title)}"
                 onerror="this.onerror=null;this.src='https://placehold.co/600x400/34d399/ffffff?text=GoCart';"
            >
          </a>
          <div class="product-info">
            <a href="product.html?slug=${encodeURIComponent(p.slug)}" class="product-title">${escapeHtml(p.title)}</a>
            <div class="text-sm mb-2">
                ${getStarRating(p.rating || 5)} <span class="text-gray-500 ml-1">(Mock Reviews)</span>
            </div>
            <p class="product-desc line-clamp-2">${escapeHtml(p.description)}</p>
            
            <div class="product-actions flex items-center justify-between pt-2 border-t border-gray-100">
                <span class="price">$${p.price.toFixed(2)}</span>
                <div class="flex items-center gap-2">
                    <!-- Cart Button with visual feedback -->
                    <button class="add-to-cart-btn" onclick="addToCart(this, '${p.id}')" aria-label="Add to Cart">
                      üõí
                    </button>
                    <!-- Wishlist Button with visual feedback -->
                    <button class="add-to-wishlist-btn" onclick="addToWishlist(this, '${p.id}')" aria-label="Add to Wishlist">
                      ‚ù§Ô∏è
                    </button>
                </div>
            </div>
          </div>
        </div>
      `).join("");

      container.innerHTML = html;
    }

    // Cart helpers
    function getCart() {
      try { return JSON.parse(localStorage.getItem('cart') || '[]'); }
      catch (e) { return []; }
    }
    function saveCart(cart) {
      localStorage.setItem('cart', JSON.stringify(cart));
      updateCartCountDisplay(); 
    }

    /**
     * Adds an item to the cart and provides visual feedback.
     * @param {HTMLElement} buttonElement - The button that was clicked.
     * @param {string} id - The product ID.
     */
    function addToCart(buttonElement, id) {
      const originalText = buttonElement.innerHTML;
      const originalClasses = buttonElement.className;

      fetch('/products.json')
        .then(res => {
            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
            return res.json();
        })
        .then(products => {
          const product = products.find(p => p.id === id);
          if (!product) return;
          
          const cart = getCart();
          const existing = cart.find(item => item.id === id);
          
          if (existing) {
            existing.quantity = (existing.quantity || 1) + 1;
          } else {
            cart.push({ ...product, quantity: 1 });
          }
          
          saveCart(cart);

          // Visual Feedback Implementation
          buttonElement.disabled = true;
          buttonElement.innerHTML = 'Added! ‚úì';
          buttonElement.classList.add('added');

          setTimeout(() => {
            buttonElement.disabled = false;
            buttonElement.innerHTML = originalText;
            // Restore the original class list fully
            buttonElement.className = originalClasses; 
            buttonElement.classList.remove('added');
          }, 1500);
        })
        .catch(error => {
            console.error("Error adding to cart:", error);
            // Ensure button is restored if fetch fails before state change
            buttonElement.disabled = false;
            buttonElement.innerHTML = originalText;
            buttonElement.className = originalClasses;
        });
    }

    // Wishlist helpers
    function getWishlist() {
      try { return JSON.parse(localStorage.getItem('wishlist') || '[]'); }
      catch (e) { return []; }
    }
    function saveWishlist(wishlist) {
      localStorage.setItem('wishlist', JSON.stringify(wishlist));
    }
    
    /**
     * Adds an item to the wishlist and provides visual feedback.
     * @param {HTMLElement} buttonElement - The button that was clicked.
     * @param {string} id - The product ID.
     */
    function addToWishlist(buttonElement, id) {
      const originalText = buttonElement.innerHTML;
      const originalClasses = buttonElement.className;

      fetch('/products.json')
        .then(res => {
            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
            return res.json();
        })
        .then(products => {
          const product = products.find(p => p.id === id);
          if (!product) return;
          
          const wishlist = getWishlist();
          const alreadyWished = wishlist.find(item => item.id === id);
          
          if (!alreadyWished) {
            wishlist.push(product);
            saveWishlist(wishlist);
            
            // Visual Feedback: Added
            buttonElement.innerHTML = 'Added!';
            buttonElement.classList.add('wished');

            setTimeout(() => {
                buttonElement.innerHTML = originalText;
                buttonElement.className = originalClasses;
            }, 1000);

          } else {
             // Visual Feedback: Already present (flash)
             buttonElement.classList.add('wished');
             setTimeout(() => buttonElement.classList.remove('wished'), 500);
          }
        })
        .catch(error => {
            console.error("Error fetching products for wishlist:", error);
            // No need to revert if error occurred before state change
        });
    }

    // Handles search bar functionality on the homepage
    function handleHeroSearch() {
      const searchInput = document.getElementById('hero-search-input');
      const searchTerm = searchInput.value.trim();
      if (searchTerm) {
        window.location.href = `shop.html?search=${encodeURIComponent(searchTerm)}`;
      }
    }

    // Load featured products and categories
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById('year').textContent = new Date().getFullYear();
      updateCartCountDisplay(); 

      // Add event listener for search bar on homepage
      const heroSearchInput = document.getElementById('hero-search-input');
      heroSearchInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
          handleHeroSearch();
        }
      });

      fetch('/products.json')
        .then(res => {
            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
            return res.json();
        })
        .then(products => {
          // Featured products (limit to 4)
          const featured = products.filter(p => p.featured).slice(0, 4); 
          // Check if products have a rating before trying to sort by it
          featured.sort((a, b) => (b.rating || 0) - (a.rating || 0)); 
          renderProducts(featured, "featured-products");

          // Group categories
          const categoriesMap = {};
          products.forEach(p => {
            if (!categoriesMap[p.primaryCategory]) {
              categoriesMap[p.primaryCategory] = new Set();
            }
            categoriesMap[p.primaryCategory].add(p.subcategory || p.primaryCategory); 
          });

          // Render primary + subcategories
          const catContainer = document.getElementById("category-buttons");
          catContainer.innerHTML = Object.keys(categoriesMap).map(primary => {
            const subs = [...categoriesMap[primary]]
                .filter(Boolean) 
                .map(sub => `
              <a class="btn small text-sm" 
                 href="shop.html?primaryCategory=${encodeURIComponent(primary)}${sub !== primary ? `&subcategory=${encodeURIComponent(sub)}` : ''}">
                ${escapeHtml(sub)}
              </a>`).join(" ");

            return `
              <div class="p-6 bg-white rounded-xl shadow-lg">
                <h3 class="text-xl font-bold text-gray-700 mb-4">${escapeHtml(primary)}</h3>
                <div class="flex flex-wrap gap-3">
                  ${subs}
                </div>
              </div>
            `;
          }).join("");
        })
        .catch(err => {
            console.error("Error loading products:", err);
            document.getElementById("featured-products").innerHTML = "<p class='text-center text-red-500'>Could not load featured products. Please check the data source.</p>";
        });
    });
  </script>
</body>
</html>
