<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Payment Successful — TrendAura Social</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="css/styles.css" />
  <style>
    /* Custom Styles for Confirmation Page */
    body { font-family: Arial, sans-serif; padding:20px; color:#222; background:#fafafa; }
    .container { max-width:900px; margin:0 auto; }
    .summary { border:1px solid #eee; padding:16px; border-radius:6px; background:#fff; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
    .item { display:flex; gap:12px; align-items:center; margin-bottom:12px; }
    .item img { width:80px; height:80px; object-fit:cover; border-radius:4px; border:1px solid #ddd; }
    .meta { flex:1; }
    .total { font-weight:700; margin-top:8px; }
    .note { color:#666; margin-top:12px; font-size:0.95rem; }
    .btn { display:inline-block; margin-top:12px; padding:8px 12px; background:#0077cc; color:#fff; text-decoration:none; border-radius:4px; transition: background 0.2s; }
    .btn:hover { background: #005f99; }
    code, pre { background:#f2f2f2; padding:8px; border-radius:6px; overflow:auto; font-size:0.9rem; }
    
    /* Invoice Link Box Styles (New Feature) */
    .invoice-box {
        margin-top: 30px;
        padding: 20px;
        background: #eaf7f1; /* Light green background */
        border: 1px solid #27ae60;
        border-radius: 8px;
        text-align: center;
    }
    .invoice-box a {
        color: #fff; /* White text on blue button */
        font-weight: 700;
        font-size: 1.1rem;
        text-decoration: none;
    }
    .invoice-box p {
        margin: 0 0 10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Thank you — Payment Successful</h1>
      <p><a href="index.html">Continue shopping</a> | <a href="shop.html">Shop</a></p>
    </header>

    <section id="confirmation" class="summary">
      <!-- Order details loaded here -->
      <p>Loading order details…</p>
    </section>

    <!-- Permanent Invoice Link Section -->
    <section id="invoice-box" class="invoice-box" style="display:none;">
        <p>Your payment details and items have been permanently saved.</p>
        <p>Click below to **View or Print your official Invoice / Receipt**:</p>
        <a href="#" id="invoice-link" target="_blank" class="btn">View Permanent Invoice</a>
    </section>

    <section class="note">
      <p>If you need help, email <strong>support@trendaurasocial.com</strong> and include the order reference shown below.</p>
    </section>
  </div>

  <script>
  (async function () {
    const params = new URLSearchParams(window.location.search);
    const orderId = params.get('paypal_order_id'); // set by your client after capture
    const container = document.getElementById('confirmation');
    const invoiceBox = document.getElementById('invoice-box');
    const invoiceLink = document.getElementById('invoice-link');

    function fmt(amount, currency='USD') {
      try {
        return new Intl.NumberFormat('en-US', { style: 'currency', currency }).format(amount);
      } catch (e) {
        return (currency || 'USD') + ' ' + (amount || '0.00');
      }
    }

    if (!orderId) {
      // No order id — show fallback message and client-side cart summary if present
      const cart = JSON.parse(localStorage.getItem('cart') || '[]');
      if (!cart.length) {
        container.innerHTML = '<h2>Payment Complete</h2><p>Your payment was processed. No order id was provided in the URL.</p>';
      } else {
        let html = '<h2>Order Received (Client-side summary)</h2>';
        cart.forEach(ci => {
          // Ensure price is treated as a number
          const price = Number(String(ci.price).replace(/[^0-9.]/g, '') || 0);
          html += `<div class="item">
            <img src="${ci.images?.[0] || '/assets/images/placeholder.png'}" alt="">
            <div class="meta">
              <div><strong>${ci.title}</strong></div>
              <div>Quantity: ${ci.quantity}</div>
              <div>Subtotal: ${fmt(price * ci.quantity, ci.currency)}</div>
            </div>
          </div>`;
        });
        const total = cart.reduce((s,i)=> s + Number(String(i.price).replace(/[^0-9.]/g, '') || 0) * i.quantity, 0);
        html += `<p class="total">Total: ${fmt(total, cart[0]?.currency || 'USD')}</p>`;
        html += '<p class="note">This is a client-side summary. The official receipt comes from PayPal and is verified server-side.</p>';
        container.innerHTML = html;
      }
      // clear local cart
      try { localStorage.removeItem('cart'); } catch(e) {}
      
      // Hide invoice box if no order ID is found
      invoiceBox.style.display = 'none';
      return;
    }

    // --- Order ID Found: Display Invoice Link & Start Verification ---
    const invoiceUrl = `/invoice.html?order_id=${encodeURIComponent(orderId)}`;
    invoiceLink.href = invoiceUrl;
    invoiceBox.style.display = 'block';

    // We have an order id — verify server-side via Netlify function
    try {
      const res = await fetch('/.netlify/functions/get-paypal-order?order_id=' + encodeURIComponent(orderId));
      if (!res.ok) {
        const errText = await res.text();
        container.innerHTML = '<h2>Order Status Check Failed</h2><p>Unable to fetch order details. Please contact support and include the order id below. Your payment was already processed.</p>'
          + `<p>Order id: <code>${orderId}</code></p>`
          + `<pre>${errText}</pre>`;
        console.error('get-paypal-order error', errText);
        return;
      }
      const order = await res.json();

      // Build confirmation UI from PayPal order info
      let html = `<h2>Order Confirmed</h2>`;
      html += `<p style="font-size: 1.1rem;">Your order is marked as **${order.status}**.</p>`;
      html += `<p><strong>PayPal Order ID:</strong> <code>${order.id}</code></p>`;

      // Purchase units and captures
      if (order.purchase_units && order.purchase_units.length) {
        order.purchase_units.forEach((pu, idx) => {
          html += `<h3>Payment Details</h3>`;
          if (pu.amount) {
            html += `<p style="font-weight: bold;">Total Amount Paid: ${pu.amount.currency_code} ${pu.amount.value}</p>`;
          }
          // If capture details are present:
          if (pu.payments && pu.payments.captures && pu.payments.captures.length) {
            pu.payments.captures.forEach(cap => {
              html += `<div class="item">
                <div class="meta">
                  <div><strong>Transaction ID:</strong> ${cap.id}</div>
                  <div>Captured amount: ${cap.amount.currency_code} ${cap.amount.value}</div>
                  <div class="note">This information confirms the payment was processed on the server.</div>
                </div>
              </div>`;
            });
          }
        });
      }

      // Show payer info if available
      if (order.payer) {
        html += `<h3>Payer Information</h3>`;
        html += `<p>${order.payer.name?.given_name || ''} ${order.payer.name?.surname || ''} | ${order.payer.email_address || 'Email not available'}</p>`;
      }

      container.innerHTML = html;

      // clear local cart (client-side)
      try { localStorage.removeItem('cart'); } catch (e) {}

    } catch (err) {
      container.innerHTML = `<h2>Order Verification Error</h2><p>There was an error verifying your order details with PayPal. Your payment likely succeeded, but please contact support and include this order id: <code>${orderId}</code></p>`;
      console.error(err);
    }
  })();
  </script>
</body>
</html>