!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Your Cart â€” TrendAura Social</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/css/styles.css" />
  <style>
    /* Page-specific */
    .cart-actions { margin-top: 14px; display:flex; gap:10px; align-items:center; }
    .qty-input { width:64px; padding:6px; border-radius:6px; border:1px solid #e6eef8; text-align:center; }
    .remove-btn { background:transparent; border:none; color:#c0392b; cursor:pointer; font-weight:700; font-size:1.05rem; }
    .remove-btn:focus { outline:3px solid rgba(192,57,43,0.12); outline-offset:3px; border-radius:6px; }
  </style>
</head>
<body>
  <header class="header" role="banner">
    <div class="inner">
      <a class="brand" href="index.html"><h1>TrendAura Social</h1></a>
      <nav class="nav" role="navigation" aria-label="Main">
        <a href="index.html">Home</a>
        <a href="shop.html">Shop</a>
        <a href="cart.html">Cart</a>
        <a href="wishlist.html">Wishlist</a>
      </nav>
    </div>
  </header>

  <main class="container" id="main">
    <h2>Your Shopping Cart</h2>

    <div id="cart-area" aria-live="polite">
      </div>

    <div id="cart-empty" class="empty" style="display:none;">
      <p>Your cart is empty.</p>
      <p><a class="btn" href="shop.html">Continue Shopping</a></p>
    </div>

    <div id="checkout-area" style="margin-top:18px; display:none;">
      <div class="summary" id="summary-box" aria-live="polite">
        <div class="line"><span>Subtotal</span><span id="subtotal-amt">$0.00</span></div>
        <div class="line"><span>Shipping</span><span id="shipping-amt">$0.00</span></div>
        <div class="line total"><span>Total</span><span id="total-amt">$0.00</span></div>

        <div id="paypal-button-container" aria-label="PayPal checkout button"></div>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="container">&copy; <span id="year"></span> TrendAura Social</div>
  </footer>

  <script src="/js/toast.js"></script>

  <script type="module">
    // === FIREBASE SETUP ===
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    let userId = null;

    if (typeof __initial_auth_token !== 'undefined') {
        signInWithCustomToken(auth, __initial_auth_token)
            .then(userCredential => { userId = userCredential.user.uid; console.log("Authenticated with Custom Token."); })
            .catch(error => { console.error("Custom Auth failed:", error); signInAnonymously(auth).then(userCredential => { userId = userCredential.user.uid; }); });
    } else {
        signInAnonymously(auth).then(userCredential => { userId = userCredential.user.uid; console.log("Signed in anonymously."); });
    }
    
    // === PayPal Helper Functions ===
    async function loadPayPalSDK() {
      // Load PayPal SDK using your Netlify function to get the client ID
      try {
        const res = await fetch('/.netlify/functions/get-paypal-client-id');
        if (!res.ok) {
          console.error('Failed to fetch PayPal client id', await res.text());
          return;
        }
        const data = await res.json();
        const clientId = data.clientId;
        if (!clientId) {
          console.error('No PayPal client id returned from server');
          return;
        }
        
        const sdkUrl = `https://www.paypal.com/sdk/js?client-id=${encodeURIComponent(clientId)}&currency=USD`;
        
        return new Promise((resolve, reject) => {
          if (window.paypal) return resolve();
          const s = document.createElement('script');
          s.src = sdkUrl;
          s.async = true;
          s.onload = () => resolve();
          s.onerror = (err) => reject(err);
          document.head.appendChild(s);
        });
      } catch (err) {
        console.error('Error loading PayPal SDK:', err);
      }
    }
    
    function renderPayPalButton() {
      if (typeof paypal === 'undefined' || !paypal.Buttons) return;
      
      const container = document.getElementById("paypal-button-container");
      if (!container || container.innerHTML.trim() !== '') return;
      
      paypal.Buttons({
        style: {
          layout: "vertical",
          color: "gold",
          shape: "rect",
          label: "paypal"
        },
        createOrder: async function (data, actions) {
          try {
            const cart = JSON.parse(localStorage.getItem("cart") || "[]");
            if (cart.length === 0) {
              // IMPORTANT: Use custom modal instead of alert
              console.error("No items in cart");
              throw new Error("No items in cart");
            }
            
            // Explicitly convert price and quantity to numbers, removing non-numeric characters first
            const subtotal = cart.reduce((sum, item) => {
              const cleanedPrice = String(item.price).replace(/[^0-9.]/g, '');
              return sum + (Number(cleanedPrice) * Number(item.quantity));
            }, 0);
            
            const shipping = subtotal > 100 ? 0 : 10;
            const total = subtotal + shipping;
            const purchase_units = [{
              amount: {
                currency_code: "USD",
                value: total.toFixed(2),
                breakdown: {
                  item_total: { currency_code: "USD", value: subtotal.toFixed(2) },
                  shipping: { currency_code: "USD", value: shipping.toFixed(2) }
                }
              }
            }];

            if (total <= 0) {
                // IMPORTANT: Use custom modal instead of alert
                console.error("Cart total is $0.00. Cannot create order."); 
                throw new Error("Cart total is $0.00");
            }

            const res = await fetch("/.netlify/functions/create-paypal-order", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ purchase_units })
            });
            const order = await res.json();
            if (!res.ok) {
              console.error("Error creating order", order);
              // IMPORTANT: Use custom modal instead of alert
              throw new Error("Order creation failed");
            }
            return order.id;
          } catch (err) {
            console.error("createOrder error:", err);
            // IMPORTANT: Use custom modal instead of alert
            throw err;
          }
        },
        onApprove: async function (data, actions) {
          try {
            const cartItems = JSON.parse(localStorage.getItem("cart") || "[]"); 

            // 1. CAPTURE PAYMENT
            const captureRes = await fetch("/.netlify/functions/capture-paypal-order", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ orderID: data.orderID }) 
            });
            const captureJson = await captureRes.json();

            if (!captureRes.ok || captureJson.status !== 'COMPLETED') {
              console.error("PayPal capture failed or incomplete", captureJson);
              window.location = "/cancel.html";
              return;
            }

            // 2. SAVE INVOICE DATA TO FIRESTORE (Publicly accessible by orderID)
            const invoiceData = {
                orderID: data.orderID,
                captureTime: new Date().toISOString(),
                // Use data directly from PayPal capture response
                payer: captureJson.payer || {},
                purchaseUnits: captureJson.purchase_units || [],
                items: cartItems, // Save the itemized cart
                transactionID: captureJson.id,
                status: captureJson.status,
            };

            // Public data path: /artifacts/{appId}/public/data/invoices/{orderID}
            const docRef = doc(db, `artifacts/${appId}/public/data/invoices`, data.orderID);
            await setDoc(docRef, invoiceData);
            console.log("Invoice data saved to Firestore for order:", data.orderID);


            // 3. CLEAR CART & REDIRECT
            try { localStorage.removeItem("cart"); } catch (e) { console.warn("Could not clear cart:", e); }
            const orderIdForUrl = encodeURIComponent(data.orderID);
            window.location = `/success.html?paypal_order_id=${orderIdForUrl}`;

          } catch (err) {
            console.error("Error in onApprove/Firestore Save:", err);
            window.location = "/cancel.html";
          }
        },
        onCancel: function (data) {
          console.log("Payment cancelled", data);
          window.location = "/cancel.html";
        },
        onError: function (err) {
          console.error("PayPal error", err);
          // IMPORTANT: Use custom modal instead of alert
          window.location = "/cancel.html";
        }
      }).render("#paypal-button-container");
    }

    // === Cart Utilities and Rendering ===
    function getCart() {
      try { return JSON.parse(localStorage.getItem('cart') || '[]'); }
      catch (e) { return []; }
    }
    function saveCart(cart) {
      localStorage.setItem('cart', JSON.stringify(cart));
    }
    function formatMoney(v, currency='USD') {
      // Ensure v is a number before formatting
      v = Number(String(v).replace(/[^0-9.]/g, '') || 0);
      try { return new Intl.NumberFormat('en-US', { style: 'currency', currency }).format(v); }
      catch (e) { return (currency || 'USD') + ' ' + v.toFixed(2); }
    }

    // This is the main function that updates the entire cart view.
    async function renderCart() {
      const cart = getCart();
      const cartArea = document.getElementById('cart-area');
      const cartEmpty = document.getElementById('cart-empty');
      const checkoutArea = document.getElementById('checkout-area');
      
      if (!cart.length) {
        cartArea.innerHTML = '';
        cartEmpty.style.display = 'block';
        checkoutArea.style.display = 'none';
        return;
      }
      
      cartEmpty.style.display = 'none';
      checkoutArea.style.display = 'block';

      let html = '<table class="cart-table"><thead><tr><th>Item</th><th>Product</th><th>Quantity</th><th>Price</th><th>Subtotal</th><th></th></tr></thead><tbody>';
      let subtotal = 0;
      cart.forEach((item, idx) => {
        // Clean price here to ensure subtotal calculation is correct
        const price = Number(String(item.price).replace(/[^0-9.]/g, '') || 0);
        const qty = Number(item.quantity || 1);
        const rowSubtotal = qty * price;
        subtotal += rowSubtotal;
        html += `<tr data-index="${idx}">
          <td><img src="${escapeHtml(item.images?.[0] || 'https://placehold.co/50x50/333/fff?text=IMG')}" alt="${escapeHtml(item.title)}"></td>
          <td>${escapeHtml(item.title)}</td>
          <td>
            <input class="qty-input" type="number" min="1" value="${qty}" data-index="${idx}" aria-label="Quantity for ${escapeHtml(item.title)}">
          </td>
          <td>${formatMoney(price, item.currency)}</td>
          <td class="subtotal-cell">${formatMoney(rowSubtotal, item.currency)}</td>
          <td><button class="remove-btn" data-index="${idx}" aria-label="Remove ${escapeHtml(item.title)} from cart">âœ•</button></td>
        </tr>`;
      });
      html += '</tbody></table>';
      cartArea.innerHTML = html;

      const shipping = subtotal > 100 ? 0 : 10;
      const total = subtotal + shipping;
      document.getElementById('subtotal-amt').textContent = formatMoney(subtotal);
      document.getElementById('shipping-amt').textContent = formatMoney(shipping);
      document.getElementById('total-amt').textContent = formatMoney(total);

      cartArea.querySelectorAll('.qty-input').forEach(input => {
        input.addEventListener('change', (e) => updateQuantity(Number(e.target.getAttribute('data-index')), Number(e.target.value)));
        input.addEventListener('keyup', (e) => { if (e.key === 'Enter') e.target.blur(); });
      });

      cartArea.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', (e) => removeItem(Number(btn.getAttribute('data-index'))));
      });
      
      await loadPayPalSDK();
      renderPayPalButton();
    }

    function updateQuantity(index, newQty) {
      if (!newQty || newQty < 1) newQty = 1;
      const cart = getCart();
      if (!cart[index]) return;
      cart[index].quantity = newQty;
      saveCart(cart);
      renderCart();
      try {
        const title = cart[index].title || 'Item';
        console.log(`${title} quantity updated: ${cart[index].quantity}`);
      } catch (e) { console.warn('updateQuantity log failed', e); }
    }

    function removeItem(index) {
      let cart = getCart();
      if (!cart[index]) return;
      const removed = cart.splice(index, 1)[0];
      saveCart(cart);
      renderCart();
      try {
        const title = removed?.title || 'Item';
        console.log(`${title} removed from cart`);
      } catch (e) { console.warn('removeItem log failed', e); }
    }

    function escapeHtml(str) {
      if (str === undefined || str === null) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }
    
    // Initial page load
    document.addEventListener('DOMContentLoaded', function () {
      document.getElementById('year').textContent = new Date().getFullYear();
      renderCart();
    });
  </script>
</body>
</html>