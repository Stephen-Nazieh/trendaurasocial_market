<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Shop — TrendAura Social</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/css/styles.css" />
</head>
<body>
  <header class="header" role="banner">
    <div class="inner">
      <a class="brand" href="index.html"><h1>TrendAura Social</h1></a>
      <nav class="nav" role="navigation" aria-label="Main">
        <a href="index.html">Home</a>
        <a href="shop.html">Shop</a>
        <a href="cart.html">Cart</a>
      </nav>
    </div>
  </header>

  <main class="container" id="main">
    <h2>Shop Products</h2>

    <div class="filter-bar">
      <label for="primaryCategory">Browse by:</label>
      <select id="primaryCategory">
        <option value="all">All Categories</option>
      </select>

      <label for="subcategory">Subcategory:</label>
      <select id="subcategory" disabled>
        <option value="all">All</option>
      </select>

      <label for="filters">Filter by:</label>
      <select id="filters" disabled>
        <option value="all">All</option>
      </select>

      <label for="sortBy" class="align-right">Sort by:</label>
      <select id="sortBy">
        <option value="default">Default</option>
        <option value="price-asc">Price: Low → High</option>
        <option value="price-desc">Price: High → Low</option>
        <option value="name-asc">Name: A → Z</option>
        <option value="name-desc">Name: Z → A</option>
      </select>
    </div>

    <div id="active-filters" class="active-filters"></div>

    <div id="shop-products" class="product-grid"></div>
  </main>

  <footer class="footer">
    <div class="container">&copy; <span id="year"></span> TrendAura Social</div>
  </footer>

  <script>
  // Escape HTML helper
  function escapeHtml(str) {
    if (str === undefined || str === null) return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  // Render products into grid
  function renderProducts(products) {
    const container = document.getElementById("shop-products");
    if (!products.length) {
      container.innerHTML = "<p>No products available.</p>";
      return;
    }

    container.innerHTML = products.map(p => `
      <div class="product-card">
        <a href="product.html?slug=${encodeURIComponent(p.slug)}" class="product-media">
          <img src="${escapeHtml(p.images[0])}" alt="${escapeHtml(p.title)}">
        </a>
        <div class="product-info">
          <a href="product.html?slug=${encodeURIComponent(p.slug)}" class="product-title">${escapeHtml(p.title)}</a>
          <p class="product-desc">${escapeHtml(p.description)}</p>
          <div class="price-row">
            <span class="price">$${p.price.toFixed(2)}</span>
            <button class="btn" onclick="addToCart('${p.id}')">Add to Cart</button>
          </div>
        </div>
      </div>
    `).join("");
  }

  // Cart helpers
  function getCart() {
    try { return JSON.parse(localStorage.getItem("cart") || "[]"); }
    catch (e) { return []; }
  }
  function saveCart(cart) {
    localStorage.setItem("cart", JSON.stringify(cart));
  }
  function addToCart(id) {
    fetch("/products.json")
      .then(res => res.json())
      .then(products => {
        const product = products.find(p => p.id === id);
        if (!product) return;
        const cart = getCart();
        const existing = cart.find(item => item.id === id);
        if (existing) {
          existing.quantity = (existing.quantity || 1) + 1;
        } else {
          cart.push({ ...product, quantity: 1 });
        }
        saveCart(cart);
        alert(product.title + " added to cart!");
      });
  }

  // Filtering + Sorting logic
  let allProducts = [];

  function updateActiveFilters(primary, subcat, filter) {
    const container = document.getElementById("active-filters");
    let text = "Browsing: ";

    if (primary === "all") {
      text += "All Products";
    } else {
      text += escapeHtml(primary);
      if (subcat && subcat !== "all") {
        text += " → " + escapeHtml(subcat);
      }
      if (filter && filter !== "all") {
        text += " (" + escapeHtml(filter) + ")";
      }
    }

    container.innerHTML = `<span class="filter-pill">${text}</span>`;
  }

  function applyFilters() {
    const primary = document.getElementById("primaryCategory").value;
    const subcat = document.getElementById("subcategory").value;
    const filter = document.getElementById("filters").value;
    const sortBy = document.getElementById("sortBy").value;

    let filtered = [...allProducts];

    // Filter by primary category
    if (primary !== "all") {
      filtered = filtered.filter(p => p.primaryCategory === primary);
    }

    // Filter by subcategory
    if (subcat !== "all" && subcat !== "" && subcat !== null) {
      filtered = filtered.filter(p => p.subcategory === subcat);
    }

    // Filter by filter (e.g., Gas, Electric)
    if (filter !== "all" && filter !== "" && filter !== null) {
      filtered = filtered.filter(p => p.filters && p.filters.includes(filter));
    }

    // Sorting
    switch (sortBy) {
      case "price-asc":
        filtered.sort((a,b) => a.price - b.price);
        break;
      case "price-desc":
        filtered.sort((a,b) => b.price - a.price);
        break;
      case "name-asc":
        filtered.sort((a,b) => a.title.localeCompare(b.title));
        break;
      case "name-desc":
        filtered.sort((a,b) => b.title.localeCompare(a.title));
        break;
    }

    // Update active filters badge
    updateActiveFilters(primary, subcat, filter);

    renderProducts(filtered);
  }

  // Read query string
  function getQueryParam(name) {
    const params = new URLSearchParams(window.location.search);
    return params.get(name);
  }

  // Populate subcategories based on primary selection
  function updateSubcategories(products, primaryValue) {
    const subcatSelect = document.getElementById("subcategory");
    const filtersSelect = document.getElementById("filters");
    
    // Clear subcategory and filter options
    subcatSelect.disabled = true;
    subcatSelect.innerHTML = `<option value="all">All</option>`;
    filtersSelect.disabled = true;
    filtersSelect.innerHTML = `<option value="all">All</option>`;

    let subcats = [];
    if (primaryValue !== "all") {
      subcats = [...new Set(products
        .filter(p => p.primaryCategory === primaryValue)
        .map(p => p.subcategory)
        .filter(Boolean))];
    }
    
    if (subcats.length) {
      subcatSelect.disabled = false;
      subcatSelect.innerHTML += subcats.map(sc => `<option value="${escapeHtml(sc)}">${escapeHtml(sc)}</option>`).join("");
    }
  }

  // Populate filters based on subcategory selection
  function updateFilters(products, primaryValue, subcatValue) {
    const filtersSelect = document.getElementById("filters");
    
    // Clear filter options
    filtersSelect.disabled = true;
    filtersSelect.innerHTML = `<option value="all">All</option>`;

    let filters = [];
    if (primaryValue === "Vehicles" && subcatValue !== "all") {
      filters = [...new Set(products
        .filter(p => p.primaryCategory === primaryValue && p.subcategory === subcatValue)
        .flatMap(p => p.filters)
        .filter(Boolean))];
    }
    
    if (filters.length) {
      filtersSelect.disabled = false;
      filtersSelect.innerHTML += filters.map(f => `<option value="${escapeHtml(f)}">${escapeHtml(f)}</option>`).join("");
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("year").textContent = new Date().getFullYear();

    const primaryFilter = document.getElementById("primaryCategory");
    const subcatFilter = document.getElementById("subcategory");
    const filtersFilter = document.getElementById("filters");

    // Get params from URL
    const primaryFromURL = getQueryParam("primaryCategory") || "all";
    const subcatFromURL = getQueryParam("subcategory") || "all";
    const filtersFromURL = getQueryParam("filters") || "all";

    // Fetch products
    fetch("/products.json")
      .then(res => res.json())
      .then(products => {
        allProducts = products;

        // Populate primary categories
        const primaryCategories = [...new Set(products.map(p => p.primaryCategory))];
        primaryFilter.innerHTML += primaryCategories.map(c => `
          <option value="${escapeHtml(c)}">${escapeHtml(c)}</option>
        `).join("");

        // Preselect primary from URL
        primaryFilter.value = primaryFromURL;

        // Populate subcategories based on primary
        updateSubcategories(products, primaryFromURL);
        if (subcatFromURL && subcatFilter.querySelector(`[value="${subcatFromURL}"]`)) {
          subcatFilter.value = subcatFromURL;
        }

        // Populate filters based on subcategorys
        updateFilters(products, primaryFromURL, subcatFromURL);
        if (filtersFromURL && filtersFilter.querySelector(`[value="${filtersFromURL}"]`)) {
          filtersFilter.value = filtersFromURL;
        }

        applyFilters(); // initial render
      });

    // Event listeners
    primaryFilter.addEventListener("change", () => {
      updateSubcategories(allProducts, primaryFilter.value);
      updateFilters(allProducts, primaryFilter.value, subcatFilter.value);
      applyFilters();
    });
    
    subcatFilter.addEventListener("change", () => {
      updateFilters(allProducts, primaryFilter.value, subcatFilter.value);
      applyFilters();
    });
    
    filtersFilter.addEventListener("change", applyFilters);
    document.getElementById("sortBy").addEventListener("change", applyFilters);
  });
  </script>
</body>
</html>