<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Shop — TrendAura Social</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/css/styles.css" />
  <style>
    .search-bar {
      position: relative;
      margin-bottom: 20px;
    }
    .search-input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 1rem;
    }
    .autocomplete-list {
      position: absolute;
      z-index: 100;
      width: 100%;
      background-color: #fff;
      border: 1px solid #ddd;
      border-top: none;
      list-style-type: none;
      padding: 0;
      margin: 0;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      max-height: 200px;
      overflow-y: auto;
      display: none;
    }
    .autocomplete-list li {
      padding: 10px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .autocomplete-list li:hover,
    .autocomplete-list li.active {
      background-color: #f0f0f0;
    }
    .add-to-cart-btn {
      flex-grow: 1;
      text-align: center;
    }
    .add-to-wishlist-btn {
      background: none;
      border: 1px solid #ddd;
      color: #777;
      padding: 8px;
      font-size: 1.2rem;
      cursor: pointer;
      border-radius: 4px;
      transition: color 0.2s, border-color 0.2s;
    }
    .add-to-wishlist-btn:hover {
      color: #e74c3c;
      border-color: #e74c3c;
    }
  </style>
</head>
<body>
  <header class="header" role="banner">
    <div class="inner">
      <a class="brand" href="index.html"><h1>TrendAura Social</h1></a>
      <nav class="nav" role="navigation" aria-label="Main">
        <a href="index.html">Home</a>
        <a href="shop.html">Shop</a>
        <a href="cart.html">Cart</a>
        <a href="wishlist.html">Wishlist</a>
      </nav>
    </div>
  </header>

  <main class="container" id="main">
    <h2>Shop Products</h2>

    <div class="filter-bar">
      <label for="primaryCategory">Browse by:</label>
      <select id="primaryCategory">
        <option value="all">All Categories</option>
      </select>

      <label for="subcategory">Subcategory:</label>
      <select id="subcategory" disabled>
        <option value="all">All</option>
      </select>

      <label for="filters">Filter by:</label>
      <select id="filters" disabled>
        <option value="all">All</option>
      </select>

      <label for="sortBy" class="align-right">Sort by:</label>
      <select id="sortBy">
        <option value="default">Default</option>
        <option value="price-asc">Price: Low → High</option>
        <option value="price-desc">Price: High → Low</option>
        <option value="name-asc">Name: A → Z</option>
        <option value="name-desc">Name: Z → A</option>
      </select>
    </div>

    <div class="search-bar">
      <input type="text" id="search-input" class="search-input" placeholder="Search for products...">
      <ul id="autocomplete-list" class="autocomplete-list"></ul>
    </div>

    <div id="active-filters" class="active-filters"></div>

    <div id="shop-products" class="product-grid"></div>
  </main>

  <footer class="footer">
    <div class="container">&copy; <span id="year"></span> TrendAura Social</div>
  </footer>

  <script>
  // Escape HTML helper
  function escapeHtml(str) {
    if (str === undefined || str === null) return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  // Render products into grid
  function renderProducts(products) {
    const container = document.getElementById("shop-products");
    if (!products.length) {
      container.innerHTML = "<p>No products available.</p>";
      return;
    }

    container.innerHTML = products.map(p => `
      <div class="product-card">
        <a href="product.html?slug=${encodeURIComponent(p.slug)}" class="product-media">
          <img src="${escapeHtml(p.images[0])}" alt="${escapeHtml(p.title)}">
        </a>
        <div class="product-info">
          <a href="product.html?slug=${encodeURIComponent(p.slug)}" class="product-title">${escapeHtml(p.title)}</a>
          <p class="product-desc">${escapeHtml(p.description)}</p>
          <div class="price-row">
            <span class="price">$${p.price.toFixed(2)}</span>
            <div style="display: flex; gap: 8px;">
              <button class="btn add-to-cart-btn" onclick="addToCart('${p.id}')">Add to Cart</button>
              <button class="add-to-wishlist-btn" onclick="addToWishlist('${p.id}')" aria-label="Add to Wishlist">❤️</button>
            </div>
          </div>
        </div>
      </div>
    `).join("");
  }

  // Cart helpers
  function getCart() {
    try { return JSON.parse(localStorage.getItem("cart") || "[]"); }
    catch (e) { return []; }
  }
  function saveCart(cart) {
    localStorage.setItem("cart", JSON.stringify(cart));
  }
  function addToCart(id) {
    fetch("/products.json")
      .then(res => res.json())
      .then(products => {
        const product = products.find(p => p.id === id);
        if (!product) return;
        const cart = getCart();
        const existing = cart.find(item => item.id === id);
        if (existing) {
          existing.quantity = (existing.quantity || 1) + 1;
        } else {
          cart.push({ ...product, quantity: 1 });
        }
        saveCart(cart);
        alert(product.title + " added to cart!");
      });
  }

  // Wishlist helpers
  function getWishlist() {
    try { return JSON.parse(localStorage.getItem('wishlist') || '[]'); }
    catch (e) { return []; }
  }
  function saveWishlist(wishlist) {
    localStorage.setItem('wishlist', JSON.stringify(wishlist));
  }
  function addToWishlist(id) {
    fetch("/products.json")
      .then(res => res.json())
      .then(products => {
        const product = products.find(p => p.id === id);
        if (!product) return;
        const wishlist = getWishlist();
        if (!wishlist.find(item => item.id === id)) {
          wishlist.push(product);
          saveWishlist(wishlist);
          alert(product.title + " added to your wishlist!");
        } else {
          alert(product.title + " is already in your wishlist.");
        }
      });
  }

  // Filtering, Sorting, and Searching logic
  let allProducts = [];

  function updateActiveFilters(primary, subcat, filter) {
    const container = document.getElementById("active-filters");
    let text = "Browsing: ";

    if (primary === "all") {
      text += "All Products";
    } else {
      text += escapeHtml(primary);
      if (subcat && subcat !== "all") {
        text += " → " + escapeHtml(subcat);
      }
      if (filter && filter !== "all") {
        text += " (" + escapeHtml(filter) + ")";
      }
    }

    container.innerHTML = `<span class="filter-pill">${text}</span>`;
  }

  function applySearchAndFilters() {
    const primary = document.getElementById("primaryCategory").value;
    const subcat = document.getElementById("subcategory").value;
    const filter = document.getElementById("filters").value;
    const sortBy = document.getElementById("sortBy").value;
    const searchTerm = document.getElementById("search-input").value.trim().toLowerCase();

    let filtered = [...allProducts];

    // Search filter
    if (searchTerm) {
      const searchTerms = searchTerm.split(' ').filter(term => term.length > 0);
      filtered = filtered.filter(p => {
        const productText = `${p.title} ${p.description} ${p.primaryCategory} ${p.subcategory} ${p.filters.join(' ')}`.toLowerCase();
        return searchTerms.every(term => productText.includes(term));
      });
    }

    // Filter by primary category
    if (primary !== "all") {
      filtered = filtered.filter(p => p.primaryCategory === primary);
    }

    // Filter by subcategory
    if (subcat !== "all" && subcat !== "" && subcat !== null) {
      filtered = filtered.filter(p => p.subcategory === subcat);
    }

    // Filter by filter (e.g., Youth, Racing)
    if (filter !== "all" && filter !== "" && filter !== null) {
      filtered = filtered.filter(p => p.filters && p.filters.includes(filter));
    }

    // Sorting
    switch (sortBy) {
      case "price-asc":
        filtered.sort((a,b) => a.price - b.price);
        break;
      case "price-desc":
        filtered.sort((a,b) => b.price - a.price);
        break;
      case "name-asc":
        filtered.sort((a,b) => a.title.localeCompare(b.title));
        break;
      case "name-desc":
        filtered.sort((a,b) => b.title.localeCompare(a.title));
        break;
    }

    // Update active filters badge
    updateActiveFilters(primary, subcat, filter);

    renderProducts(filtered);
  }
  
  // Autocomplete functionality
  function searchAndAutocomplete(query) {
    const searchTerm = query.toLowerCase().trim();
    const autocompleteList = document.getElementById('autocomplete-list');
    
    if (searchTerm.length < 2) {
      autocompleteList.style.display = 'none';
      return;
    }
    
    const searchTerms = searchTerm.split(/\s+/).filter(term => term.length > 0);

    const uniqueSuggestions = new Set();
    allProducts.forEach(p => {
        const productText = `${p.title} ${p.description} ${p.primaryCategory} ${p.subcategory} ${p.filters.join(' ')}`.toLowerCase();
        
        searchTerms.forEach(term => {
            let index = productText.indexOf(term);
            while (index !== -1 && uniqueSuggestions.size < 5) {
                const end = productText.indexOf(' ', index + term.length);
                const word = end === -1 ? productText.substring(index) : productText.substring(index, end);
                uniqueSuggestions.add(word);
                index = productText.indexOf(term, index + 1);
            }
        });
    });

    const suggestions = [...uniqueSuggestions];

    if (suggestions.length) {
      autocompleteList.innerHTML = suggestions.map(s => `<li>${escapeHtml(s)}</li>`).join('');
      autocompleteList.style.display = 'block';
    } else {
      autocompleteList.style.display = 'none';
    }
  }

  // Read query string
  function getQueryParam(name) {
    const params = new URLSearchParams(window.location.search);
    return params.get(name);
  }

  // Populate subcategories based on primary selection
  function updateSubcategories(products, primaryValue) {
    const subcatSelect = document.getElementById("subcategory");
    const filtersSelect = document.getElementById("filters");
    
    // Clear subcategory and filter options
    subcatSelect.disabled = true;
    subcatSelect.innerHTML = `<option value="all">All</option>`;
    filtersSelect.disabled = true;
    filtersSelect.innerHTML = `<option value="all">All</option>`;

    let subcats = [];
    if (primaryValue !== "all") {
      subcats = [...new Set(products
        .filter(p => p.primaryCategory === primaryValue)
        .map(p => p.subcategory)
        .filter(Boolean))];
    }
    
    if (subcats.length) {
      subcatSelect.disabled = false;
      subcatSelect.innerHTML += subcats.map(sc => `<option value="${escapeHtml(sc)}">${escapeHtml(sc)}</option>`).join("");
    }
  }

  // Populate filters based on category and subcategory selection
  function updateFilters(products, primaryValue, subcatValue) {
    const filtersSelect = document.getElementById("filters");
    
    // Clear filter options
    filtersSelect.disabled = true;
    filtersSelect.innerHTML = `<option value="all">All</option>`;

    let filters = [];
    if (subcatValue !== "all" && subcatValue !== "" && subcatValue !== null) {
      filters = [...new Set(products
        .filter(p => p.primaryCategory === primaryValue && p.subcategory === subcatValue)
        .flatMap(p => p.filters)
        .filter(Boolean))];
    }
    
    if (filters.length) {
      filtersSelect.disabled = false;
      filtersSelect.innerHTML += filters.map(f => `<option value="${escapeHtml(f)}">${escapeHtml(f)}</option>`).join("");
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("year").textContent = new Date().getFullYear();

    const primaryFilter = document.getElementById("primaryCategory");
    const subcatFilter = document.getElementById("subcategory");
    const filtersFilter = document.getElementById("filters");
    const searchInput = document.getElementById("search-input");
    const autocompleteList = document.getElementById("autocomplete-list");

    // Get params from URL
    const primaryFromURL = getQueryParam("primaryCategory") || "all";
    const subcatFromURL = getQueryParam("subcategory") || "all";
    const filtersFromURL = getQueryParam("filters") || "all";

    // Fetch products
    fetch("/products.json")
      .then(res => res.json())
      .then(products => {
        allProducts = products;

        // Populate primary categories
        const primaryCategories = [...new Set(products.map(p => p.primaryCategory))];
        primaryFilter.innerHTML += primaryCategories.map(c => `
          <option value="${escapeHtml(c)}">${escapeHtml(c)}</option>
        `).join("");

        // Preselect primary from URL
        primaryFilter.value = primaryFromURL;

        // Populate subcategories based on primary
        updateSubcategories(products, primaryFromURL);
        if (subcatFromURL && subcatFilter.querySelector(`[value="${subcatFromURL}"]`)) {
          subcatFilter.value = subcatFromURL;
        }

        // Populate filters based on subcategory
        updateFilters(products, primaryFromURL, subcatFromURL);
        if (filtersFromURL && filtersFilter.querySelector(`[value="${filtersFromURL}"]`)) {
          filtersFilter.value = filtersFromURL;
        }

        applySearchAndFilters(); // initial render
      });

    // Event listeners
    primaryFilter.addEventListener("change", () => {
      updateSubcategories(allProducts, primaryFilter.value);
      updateFilters(allProducts, primaryFilter.value, subcatFilter.value);
      applySearchAndFilters();
    });
    
    subcatFilter.addEventListener("change", () => {
      updateFilters(allProducts, primaryFilter.value, subcatFilter.value);
      applySearchAndFilters();
    });
    
    filtersFilter.addEventListener("change", applySearchAndFilters);
    document.getElementById("sortBy").addEventListener("change", applySearchAndFilters);

    // Search bar event listeners
    searchInput.addEventListener("input", (e) => {
      searchAndAutocomplete(e.target.value);
      applySearchAndFilters();
    });
    
    autocompleteList.addEventListener('click', (e) => {
      if (e.target.tagName === 'LI') {
        searchInput.value = e.target.textContent;
        autocompleteList.style.display = 'none';
        applySearchAndFilters();
      }
    });

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.search-bar')) {
        autocompleteList.style.display = 'none';
      }
    });
  });
  </script>
</body>
</html>